require 'test/unit'
require "wiki_parser"

class WikiParserTest < Test::Unit::TestCase

  def txest_many_ticket_links
    str = '#20, #23, #24, #33, #35, #38, #41, #44, #46, #50, #51, #52, #53, #54, #66, #67, #68, #72, #73, #75, #76, #77, #78, #79, #83, #90, #92, #93, #94, #97, #100, #101, #102, #103, #104, #105, #106, #110, #111, #112, #116, #117, #118, #119, #120, #121, #123, #124, #126, #129, #130, #131, #132, #133, #135, #136, #137, #138, #139, #140, #141, #142, #144, #146, #149, #153, #154, #156, #157, #159, #160, #161, #163, #164, #166, #168, #171, #172, #173, #176, #178, #179, #183, #185, #188, #189, #191, #192, #193, #194, #196, #197, #198, #199, #200, #201, #202, #203, #204, #205, #206, #208, #210, #211, #212, #214, #215, #216, #217, #218, #220, #221, #223, #224, #225, #226, #227, #228, #229, #230, #231, #232, #236, #237, #238, #239, #240, #241, #242, #243, #244, #246, #247, #248, #249, #250, #252, #253, #255, #256, #258, #261, #262, #263, #264, #265, #266, #268, #269, #271, #272, #273, #274, #275, #276, #277, #278, #279, #280, #281, #282, #285, #286, #287, #288, #289, #290, #293, #295, #296, #299, #309, #310, #311, #313, #315, #316, #318, #319, #320, #321, #324, #327, #328, #341, #344, #345, #346, #350, #351, #352, #354, #355, #361, #364, #365, #366, #367, #368, #370, #371, #372, #375, #377, #379, #382, #385, #386, #413, #416, #417, #421, #422, #438, #446, #447, #450, #451, #471, #481, #482, #487, #491, #492, #508, #509, #515, #518, #519, #534, #536, #546, #553, #554, #555, #561, #564, #566, #569, #570, #571, #574, #575, #587, #596, #599, #602, #605, #606, #607, #608, #609, #610, #611, #612, #614, #618, #619, #620, #622, #623, #625, #635, #648, #650, #653, #655, #659, #672, #676, #683, #684, #686, #687, #688, #715, #716, #718, #719, #725, #726, #727, #730, #737, #738, #739, #740, #741, #743, #744, #745, #747, #749, #750, #751, #752, #761, #762, #763, #764, #765, #766, #767, #768, #772, #784, #789, #803, #804, #805, #808'
    assert_equal 621, Breakout::WikiParser.parse(str).size
  end

  def test_ticket_links
    check '#20, #22434343, #24, #33',
    [[:ticket, "20"], [:chars, ", "], [:ticket, "22434343"], [:chars, ", "], [:ticket, "24"], [:chars, ", "], [:ticket, "33"]]
  end

  def test_short_ticket
    check "#1 >#2< #3e # #e4 #6", [[:ticket, "1"], [:chars, " >"], [:ticket, "2"], [:chars, "< "], [:ticket, "3"], [:chars, "e # #e4 "], [:ticket, "6"]]
  end

  def test_svn_rev
    check 'Fixed in r1234', [[:chars, "Fixed in "], [:svn, "1234"]]
    check 'r1234 contains fix', [[:svn, "1234"], [:chars, " contains fix"]]
  end

  def test_git_rev
    check 'Fixed in [12a3f4a]', [[:chars, "Fixed in "], [:git, "12a3f4a"]]
  end

  def test_ticket_template
    check "[[ticket:1]] >[[ticket:2]]< [[ticket:3e]] [[ticket:e4]] [[ticket:6]]",
    [[:ticket, "1"],
     [:chars, " >"],
     [:ticket, "2"],
     [:chars, "< [[ticket:3e]] [[ticket:e4]] "],
     [:ticket, "6"]]
  end

  def test_old_commits
    check '2>1 and 2<3.r fÃ¼r3 r1 [2] [we] (r3: r4e) [2efc5a4b8d]', []
  end

  def check(str, rez)
    assert_equal rez, Breakout::WikiParser.parse(str), str
  end
end
